FROM node:20-alpine AS builder

WORKDIR /app

# Build args for Next.js (NEXT_PUBLIC_* must be set at build time)
ARG NEXT_PUBLIC_NETWORK_ID=mainnet
ARG NEXT_PUBLIC_OUTLAYER_CONTRACT=outlayer.near
ARG NEXT_PUBLIC_OUTLAYER_API_URL=https://outlayer.xyz
ARG NEXT_PUBLIC_PROJECT_ID=near-email
ARG NEXT_PUBLIC_SECRETS_PROFILE=default
ARG NEXT_PUBLIC_SECRETS_ACCOUNT_ID=
ARG NEXT_PUBLIC_USE_SECRETS=true
ARG NEXT_PUBLIC_DB_API_URL=https://mail.near.email

# Set as env vars for build
ENV NEXT_PUBLIC_NETWORK_ID=$NEXT_PUBLIC_NETWORK_ID
ENV NEXT_PUBLIC_OUTLAYER_CONTRACT=$NEXT_PUBLIC_OUTLAYER_CONTRACT
ENV NEXT_PUBLIC_OUTLAYER_API_URL=$NEXT_PUBLIC_OUTLAYER_API_URL
ENV NEXT_PUBLIC_PROJECT_ID=$NEXT_PUBLIC_PROJECT_ID
ENV NEXT_PUBLIC_SECRETS_PROFILE=$NEXT_PUBLIC_SECRETS_PROFILE
ENV NEXT_PUBLIC_SECRETS_ACCOUNT_ID=$NEXT_PUBLIC_SECRETS_ACCOUNT_ID
ENV NEXT_PUBLIC_USE_SECRETS=$NEXT_PUBLIC_USE_SECRETS
ENV NEXT_PUBLIC_DB_API_URL=$NEXT_PUBLIC_DB_API_URL

COPY package*.json ./
RUN npm install

COPY . .
RUN mkdir -p public
RUN npm run build

FROM node:20-alpine

WORKDIR /app

COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public ./public

EXPOSE 3000
ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "server.js"]
