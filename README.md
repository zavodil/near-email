# NEAR Email

Blockchain-native email for NEAR accounts. Every NEAR account automatically has an email address: `alice.near` -> `alice@near.email`

## Architecture

```
External World (Gmail, etc.)
        │
        │ SMTP (port 25)
        ▼
┌─────────────────────────────────────────┐
│        smtp-server (Rust)               │
│  - Receives *@near.email                │
│  - Derives public key from account_id   │
│  - Encrypts email with ECIES            │
│  - Stores encrypted blob in PostgreSQL  │
└─────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────┐
│        PostgreSQL                       │
│  - Encrypted emails (only owner decrypt)│
└─────────────────────────────────────────┘
        │
        │ HTTP API
        ▼
┌─────────────────────────────────────────┐
│        OutLayer TEE                     │
│  - Verifies NEAR signature              │
│  - Derives private key from master      │
│  - Decrypts emails for owner            │
└─────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────┐
│        web-ui (Next.js)                 │
│  - Connect NEAR wallet                  │
│  - Sign message to prove ownership      │
│  - View decrypted inbox                 │
└─────────────────────────────────────────┘
```

## Components

| Directory | Description |
|-----------|-------------|
| `smtp-server/` | Rust SMTP server that receives and encrypts emails |
| `wasi-near-email-ark/` | OutLayer WASI module for decryption |
| `db-api/` | HTTP API for database access from WASI |
| `web-ui/` | Next.js frontend for inbox |

## Key Derivation (BIP32-style)

The critical feature: SMTP server can derive public keys WITHOUT knowing the master secret.

```
Master Keypair (generated once in TEE):
  master_private_key → stored in OutLayer secrets
  master_public_key  → published, available to SMTP server

Public Key Derivation (SMTP server, no secret needed):
  user_pubkey = master_pubkey + SHA256("near-email:v1:" + account_id) * G

Private Key Derivation (OutLayer TEE, requires secret):
  user_privkey = master_privkey + SHA256("near-email:v1:" + account_id)
```

## Quick Start

### Option A: Docker Compose (Recommended)

```bash
# 2. Set environment variable
export MASTER_PUBLIC_KEY=<from wasi>

# 3. Run everything
docker-compose up -d
```

### Option B: Manual Setup

#### 1. Get MASTER_PUBLIC_KEY from WASI

#### 2. Run SMTP Server

```bash
cd smtp-server
cp .env.example .env
# Edit .env with your settings
cargo run
```

#### 3. Run DB API

```bash
cd db-api
DATABASE_URL=postgres://... cargo run
```

#### 4. Deploy WASI Module

```bash
cd wasi-near-email-ark
./build.sh
# Deploy to OutLayer with secrets:
#   PROTECTED_MASTER_KEY=<auto-generated-in-tee>...
#   DATABASE_API_URL=https://your-db-api-url
```

#### 5. Run Web UI

```bash
cd web-ui
npm install
npm run dev
```

## Payment Key Mode (HTTPS API)

The web UI supports two modes of operation:

### Transaction Mode (Default)
- Each operation sends a NEAR blockchain transaction
- Authenticated via wallet signature
- ~0.1 NEAR deposit per operation
- Limited to ~1.5 MB response size

### Payment Key Mode
- Operations via HTTPS API (no blockchain transactions)
- Authenticated via Payment Key
- Costs deducted from prepaid USDC/USDT balance
- **25 MB response size** (larger attachments)
- **Faster** (no transaction confirmation wait)

### How to Use Payment Key Mode

1. **Get a Payment Key** from [OutLayer Dashboard](https://outlayer.fastnear.com/dashboard):
   - Create a new Payment Key
   - Top up balance with USDC/USDT
   - Copy the key (format: `owner:nonce:secret`)

2. **Configure in web UI**:
   - Click on your account dropdown
   - Click "Configure" under Payment Key section
   - Paste your key
   - Toggle "Payment Key" switch ON

3. **Switch between modes**:
   - Toggle ON: Uses HTTPS API (Payment Key balance)
   - Toggle OFF: Uses blockchain transactions (NEAR wallet)

### Resource Limits by Mode

| Parameter | Transaction | Payment Key |
|-----------|-------------|-------------|
| max_output_size | 1.5 MB | 25 MB |
| max_memory_mb | 128 | 256 |
| max_instructions | 100M | 500M |
| max_execution_seconds | 60 | 120 |

### Storage
- Payment Key stored in browser `localStorage`
- Key and toggle state stored separately
- Never sent to any server except OutLayer API

## Environment Variables

### smtp-server

| Variable | Description |
|----------|-------------|
| `DATABASE_URL` | PostgreSQL connection string |
| `MASTER_PUBLIC_KEY` | Hex-encoded secp256k1 public key |
| `SMTP_PORT` | SMTP listen port (default: 25) |

### wasi-near-email-ark (OutLayer secrets)

| Variable | Description |
|----------|-------------|
| `PROTECTED_MASTER_KEY` | Hex-encoded secp256k1 private key, generated in tee |
| `DATABASE_API_URL` | HTTP API URL for database access |

### web-ui

| Variable | Description |
|----------|-------------|
| `NEXT_PUBLIC_NETWORK_ID` | NEAR network: `mainnet` or `testnet` |
| `NEXT_PUBLIC_OUTLAYER_API_URL` | OutLayer API URL for HTTPS mode |
| `NEXT_PUBLIC_PROJECT_ID` | OutLayer project ID (e.g., `zavodil2.testnet/near-email`) |
| `NEXT_PUBLIC_SECRETS_PROFILE` | Secrets profile name (default: `default`) |
| `NEXT_PUBLIC_SECRETS_ACCOUNT_ID` | Account that stores secrets |

## DNS Configuration

```dns
near.email.              MX     10    mail.near.email.
mail.near.email.         A      <your-server-ip>
near.email.              TXT    "v=spf1 ip4:<your-server-ip> -all"
```

## Security Model

- **Server compromise**: Emails encrypted, server only has public key
- **Master key leak**: Key stored only in OutLayer TEE
- **Spam**: Rate limiting before encryption
- **Impersonation**: DKIM/SPF/DMARC for outgoing mail

## Production Deployment

See [DEPLOY.md](DEPLOY.md) for full deployment guide including:
- VPS setup (Hetzner/OVH/Vultr)
- DNS configuration
- SSL certificates
- OutLayer secrets
- Monitoring and backups
